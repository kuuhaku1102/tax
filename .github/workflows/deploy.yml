name: Deploy WordPress Theme to ConoHa WING
# â†‘ ã€å¤‰æ›´OKã€‘ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åï¼ˆãƒ†ãƒ¼ãƒåãƒ»æ¡ˆä»¶åã«åˆã‚ã›ã¦ï¼‰

on:
  push:
    branches: [ main ]
    # â†‘ ã€å¤‰æ›´OKã€‘æœ¬ç•ªãƒ–ãƒ©ãƒ³ãƒåï¼ˆstaging / develop ãªã©ã§ã‚‚å¯ï¼‰
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # â‘  ãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # â‘¡ SSHç–é€šç¢ºèªï¼ˆä»»æ„ï¼‰
      # â€» ãƒ‡ãƒãƒƒã‚°ç”¨é€”ã€‚ä¸è¦ãªã‚‰å‰Šé™¤OK
      # ----------------------------
      - name: Test SSH connection (optional)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p 8022 -H www1012.conoha.ne.jp >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_ed25519 -p 8022 \
            c3659606@www1012.conoha.ne.jp \
            "echo 'âœ… SSH connection successful' && pwd"

          # â†‘ ã€å¤‰æ›´å¿…é ˆã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼å
          # â†‘ ã€å¤‰æ›´å¿…é ˆã€‘ã‚µãƒ¼ãƒãƒ¼å
          # â†‘ ã€å¤‰æ›´å¿…é ˆã€‘ãƒãƒ¼ãƒˆï¼ˆConoHaã¯é€šå¸¸ 8022ï¼‰

      # ----------------------------
      # â‘¢ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
      # ----------------------------
      - name: Create backup on remote server
        run: |
          ssh -i ~/.ssh/id_ed25519 -p 8022 \
            c3659606@www1012.conoha.ne.jp << 'ENDSSH'
            THEME_DIR="public_html/elmolinitos.com/wp-content/themes/tax-matching-theme"
            BACKUP_DIR="public_html/elmolinitos.com/wp-content/themes/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Create backup directory if not exists
            mkdir -p "$BACKUP_DIR"
            
            # Create backup if theme directory has content
            if [ -d "$THEME_DIR" ] && [ "$(ls -A $THEME_DIR 2>/dev/null)" ]; then
              echo "ğŸ“¦ Creating backup: $BACKUP_DIR/tax-matching-theme_$TIMESTAMP"
              cp -r "$THEME_DIR" "$BACKUP_DIR/tax-matching-theme_$TIMESTAMP"
              echo "âœ… Backup created successfully"
              
              # Keep only last 5 backups
              cd "$BACKUP_DIR"
              ls -t | tail -n +6 | xargs -r rm -rf
              echo "ğŸ§¹ Old backups cleaned up"
            else
              echo "â„¹ï¸  Theme directory is empty or does not exist, skipping backup"
            fi
          ENDSSH

      # ----------------------------
      # â‘£ ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      # ----------------------------
      - name: Deploy WordPress Theme via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.6
        with:
          # ===== æ¥ç¶šæƒ…å ± =====
          server: www1012.conoha.ne.jp
          # â†‘ ã€å¤‰æ›´å¿…é ˆã€‘ConoHaã®ãƒ›ã‚¹ãƒˆå

          port: 8022
          # â†‘ ã€é€šå¸¸å›ºå®šã€‘ConoHaã¯ 8022

          username: c3659606
          # â†‘ ã€å¤‰æ›´å¿…é ˆã€‘ConoHaã®FTP/SSHãƒ¦ãƒ¼ã‚¶ãƒ¼

          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          # â†‘ ã€å›ºå®šã€‘GitHub Secrets ã«ç™»éŒ²ã—ãŸç§˜å¯†éµ

          # ===== ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š =====
          local_path: ./
          # â†‘ ã€é€šå¸¸å›ºå®šã€‘GitHubãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ï¼ãƒ†ãƒ¼ãƒä¸­èº«

          # ===== ãƒªãƒ¢ãƒ¼ãƒˆè¨­å®š =====
          remote_path: public_html/elmolinitos.com/wp-content/themes/tax-matching-theme/
          # â†‘ ã€å¤‰æ›´å¿…é ˆã€‘
          #   - ãƒ‰ãƒ¡ã‚¤ãƒ³å: elmolinitos.com
          #   - ãƒ†ãƒ¼ãƒãƒ•ã‚©ãƒ«ãƒ€å: tax-matching-theme
          # â€» ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯äº‹å‰ã«å­˜åœ¨ã—ã¦ã„ã‚‹å¿…è¦ã‚ã‚Š

          sftp_only: true
          # â†‘ ã€å›ºå®šã€‘ConoHa WING æ¨å¥¨

          delete_remote_files: false
          # â†‘ ã€ä»»æ„ã€‘
          #   true  = GitHubã«ç„¡ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ï¼ˆæ…é‡ã«ï¼‰
          #   false = æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ®‹ã™ï¼ˆå®‰å…¨ï¼‰

          # ===== é™¤å¤–è¨­å®š =====
          rsyncArgs: --exclude=.git/ --exclude=.github/ --exclude=docs/ --exclude=node_modules/ --exclude=.env --exclude=.DS_Store --exclude=*.py --exclude=*.md --exclude=*.backup* --exclude=*.old --exclude=.gitignore
          # â†‘ ã€é€šå¸¸å›ºå®šã€‘ãƒ†ãƒ¼ãƒã«ä¸è¦ãªã‚‚ã®ã‚’é™¤å¤–
          # .git/     = Gitãƒªãƒã‚¸ãƒˆãƒª
          # .github/  = GitHub Actionsè¨­å®š
          # docs/     = ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          # *.md      = Markdownãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆREADMEç­‰ï¼‰
          # *.backup* = ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
          # *.old     = å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«

      # ----------------------------
      # â‘¤ ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼
      # ----------------------------
      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_ed25519 -p 8022 \
            c3659606@www1012.conoha.ne.jp << 'ENDSSH'
            THEME_DIR="public_html/elmolinitos.com/wp-content/themes/tax-matching-theme"
            
            echo "ğŸ” Verifying deployment..."
            if [ -f "$THEME_DIR/style.css" ]; then
              echo "âœ… Deployment verified: style.css exists"
              echo ""
              echo "ğŸ“ Files in theme directory:"
              ls -lh "$THEME_DIR"
              echo ""
              echo "ğŸ‰ Deployment completed successfully!"
              exit 0
            else
              echo "âŒ Deployment failed: style.css not found"
              exit 1
            fi
          ENDSSH

      # ----------------------------
      # â‘¥ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
      # ----------------------------
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âš ï¸  Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/id_ed25519 -p 8022 \
            c3659606@www1012.conoha.ne.jp << 'ENDSSH'
            THEME_DIR="public_html/elmolinitos.com/wp-content/themes/tax-matching-theme"
            BACKUP_DIR="public_html/elmolinitos.com/wp-content/themes/backups"
            
            # Get the latest backup
            if [ -d "$BACKUP_DIR" ]; then
              LATEST_BACKUP=$(ls -t "$BACKUP_DIR" 2>/dev/null | head -n 1)
              
              if [ -n "$LATEST_BACKUP" ]; then
                echo "ğŸ”„ Rolling back to: $LATEST_BACKUP"
                rm -rf "$THEME_DIR"
                cp -r "$BACKUP_DIR/$LATEST_BACKUP" "$THEME_DIR"
                echo "âœ… Rollback completed successfully"
                exit 0
              else
                echo "âš ï¸  No backup found for rollback (this might be the first deployment)"
                exit 0
              fi
            else
              echo "âš ï¸  Backup directory does not exist (this might be the first deployment)"
              exit 0
            fi
          ENDSSH

      # ----------------------------
      # â‘¦ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      # ----------------------------
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
