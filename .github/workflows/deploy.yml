name: Deploy WordPress Theme

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts
      
      - name: Create backup on remote server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USER@$SSH_HOST << 'ENDSSH'
            THEME_DIR="/public_html/elmolinitos.com/wp-content/themes/tax-matching-theme"
            BACKUP_DIR="/public_html/elmolinitos.com/wp-content/themes/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Create backup directory if not exists
            mkdir -p $BACKUP_DIR
            
            # Create backup
            if [ -d "$THEME_DIR" ]; then
              echo "Creating backup: $BACKUP_DIR/tax-matching-theme_$TIMESTAMP"
              cp -r $THEME_DIR $BACKUP_DIR/tax-matching-theme_$TIMESTAMP
              echo "Backup created successfully"
            else
              echo "Theme directory does not exist yet, skipping backup"
            fi
            
            # Keep only last 5 backups
            cd $BACKUP_DIR
            ls -t | tail -n +6 | xargs -r rm -rf
            echo "Old backups cleaned up"
          ENDSSH
      
      - name: Deploy files via rsync
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p $SSH_PORT" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='README.md' \
            ./ $SSH_USER@$SSH_HOST:/public_html/elmolinitos.com/wp-content/themes/tax-matching-theme/
      
      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USER@$SSH_HOST << 'ENDSSH'
            THEME_DIR="/public_html/elmolinitos.com/wp-content/themes/tax-matching-theme"
            
            if [ -f "$THEME_DIR/style.css" ]; then
              echo "✓ Deployment verified: style.css exists"
              echo "Files in theme directory:"
              ls -lh $THEME_DIR
              exit 0
            else
              echo "✗ Deployment failed: style.css not found"
              exit 1
            fi
          ENDSSH
      
      - name: Rollback on failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          echo "Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USER@$SSH_HOST << 'ENDSSH'
            THEME_DIR="/public_html/elmolinitos.com/wp-content/themes/tax-matching-theme"
            BACKUP_DIR="/public_html/elmolinitos.com/wp-content/themes/backups"
            
            # Get the latest backup
            LATEST_BACKUP=$(ls -t $BACKUP_DIR | head -n 1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Rolling back to: $LATEST_BACKUP"
              rm -rf $THEME_DIR
              cp -r $BACKUP_DIR/$LATEST_BACKUP $THEME_DIR
              echo "✓ Rollback completed successfully"
            else
              echo "✗ No backup found for rollback"
              exit 1
            fi
          ENDSSH
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
