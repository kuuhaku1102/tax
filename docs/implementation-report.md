# 税理士マッチングサイト 実装完了レポート

**作成日**: 2026-01-19  
**バージョン**: 1.0.0  
**ステータス**: ✅ 実装完了

---

## 実装概要

税理士マッチングサイトの基盤構築が完了しました。設計思想「管理しやすく、更新しやすく、壊れにくい」に基づき、以下の機能を実装しました。

---

## 実装内容

### 1. カスタム投稿タイプ

#### `tax_service`（税理士サービス）

- **設計意図**: 税理士「個人」ではなく「サービス単位」で管理
- **スラッグ**: `/services/`
- **サポート**: タイトル、本文、アイキャッチ画像
- **管理画面**: 専用アイコン（dashicons-businessperson）

**実装ファイル**: `functions.php`

---

### 2. タクソノミー

| タクソノミー | 役割 | 階層 | 変更頻度 |
|------------|------|------|---------|
| `service_industry` | 業種 | あり | 低 |
| `service_issue` | 課題・目的 | あり | 低 |
| `service_phase` | フェーズ | なし | 中 |
| `service_area` | 対応エリア | あり | 低 |
| `service_tag` | 補助タグ | なし | 高 |

**設計意図**:
- 変更頻度が低いものは専用タクソノミー
- 変更頻度が高いものは `service_tag` に集約
- 階層構造が必要なものは `hierarchical => true`

**実装ファイル**: `functions.php`

---

### 3. ACFフィールドグループ

#### 基本情報（`group_basic_info`）

| フィールド名 | タイプ | 必須 | 説明 |
|------------|--------|------|------|
| 事務所名 | テキスト | ✅ | 税理士事務所の正式名称 |
| 代表者名 | テキスト | - | 代表税理士の氏名 |
| 事務所URL | URL | - | 公式サイトのURL |
| 電話番号 | テキスト | - | 問い合わせ用電話番号 |
| メールアドレス | メール | - | 問い合わせ用メールアドレス |
| 所在地 | テキストエリア | - | 事務所の住所 |
| キャッチコピー | テキスト | - | 一覧ページ用の短い説明文 |

#### 掲載制御（`group_listing_control`）

| フィールド名 | タイプ | 初期値 | 説明 |
|------------|--------|--------|------|
| 掲載ステータス | ON/OFF | OFF | 公開ページへの表示制御 |
| 注目サービス | ON/OFF | OFF | トップページ表示制御 |
| 掲載プラン | 選択 | ベーシック | プレミアム/スタンダード/ベーシック |
| 優先度スコア | 数値 | 50 | 表示順序の制御（0-1000） |
| 掲載開始日 | 日付 | - | 掲載を開始する日付 |
| 掲載終了日 | 日付 | - | 掲載を終了する日付 |

#### 編集部評価（`group_editor_review`）

| フィールド名 | タイプ | 初期値 | 説明 |
|------------|--------|--------|------|
| 編集部評価 | 数値（1-5） | 3 | 編集部による評価スコア |
| おすすめポイント | WYSIWYG | - | 編集部が推薦する理由 |
| こんな人におすすめ | WYSIWYG | - | おすすめの対象者 |
| 編集部メモ | テキストエリア | - | 管理用メモ（非公開） |

#### サービス詳細（`group_service_detail`）

| フィールド名 | タイプ | 説明 |
|------------|--------|------|
| サービスの特徴 | WYSIWYG | サービスの強み・特色 |
| サービスの流れ | WYSIWYG | 相談から契約までの流れ |
| 料金情報 | WYSIWYG | 料金体系・価格の目安 |
| 相談方法 | チェックボックス | 対応可能な相談方法（複数選択可） |
| 対応スピード | 選択 | 通常の対応スピード |

#### トラッキング・分析（`group_tracking`）

| フィールド名 | タイプ | 初期値 | 説明 |
|------------|--------|--------|------|
| 閲覧数 | 数値 | 0 | ページビュー数 |
| 問い合わせ数 | 数値 | 0 | 問い合わせ件数 |
| 成約率（%） | 数値 | 0 | 成約率 |
| 最終更新日時 | 日時 | - | 情報を更新した日時 |

**実装ファイル**: `acf-json/*.json`

---

### 4. テンプレートファイル

#### `single-tax_service.php`（サービス詳細ページ）

**主な機能**:
- 掲載ステータスチェック
- パンくずリスト表示
- タクソノミー情報表示
- 掲載プランバッジ表示
- 編集部評価・おすすめポイント表示
- サービス詳細情報表示
- お問い合わせボタン表示
- 関連サービス表示

**設計思想**:
- ACFフィールドの存在チェックを徹底
- 表示ロジックをヘルパー関数に委譲
- HTMLとPHPを明確に分離

#### `archive-tax_service.php`（サービス一覧ページ）

**主な機能**:
- 検索・フィルターフォーム
- タクソノミーによる絞り込み
- 並び順の変更（おすすめ順/新着順/名前順）
- サービスカード一覧表示
- ページネーション
- 注目サービス表示

#### `taxonomy-service_industry.php`（業種別一覧ページ）

**主な機能**:
- 業種別のサービス一覧表示
- タクソノミー説明文の表示
- サービスカード一覧表示
- ページネーション

#### `taxonomy-service_issue.php`（課題別一覧ページ）

**主な機能**:
- 課題別のサービス一覧表示
- タクソノミー説明文の表示
- サービスカード一覧表示
- ページネーション

**実装ファイル**: `single-tax_service.php`, `archive-tax_service.php`, `taxonomy-*.php`

---

### 5. ヘルパー関数

#### `inc/helpers.php`（汎用ヘルパー関数）

| 関数名 | 説明 |
|--------|------|
| `get_field_safe()` | ACFフィールドの安全な取得 |
| `get_taxonomy_terms_list()` | タクソノミータームの取得 |
| `the_taxonomy_terms_links()` | タクソノミータームのリンク表示 |
| `is_service_active()` | サービスの掲載ステータスチェック |
| `get_listing_plan_label()` | 掲載プランのラベル取得 |
| `get_services_archive_url()` | サービス一覧ページのURL取得 |

#### `inc/query.php`（クエリ関連関数）

| 関数名 | 説明 |
|--------|------|
| `get_active_services()` | 掲載中のサービスを取得 |
| `get_featured_services()` | 注目サービスを取得 |
| `get_related_services()` | 関連サービスを取得 |
| `build_search_query_from_params()` | 検索クエリの構築 |

#### `inc/display.php`（表示関連関数）

| 関数名 | 説明 |
|--------|------|
| `display_service_card()` | サービスカードの表示 |
| `display_service_detail()` | サービス詳細情報の表示 |
| `display_breadcrumb()` | パンくずリストの表示 |
| `display_pagination()` | ページネーションの表示 |
| `display_taxonomy_filter()` | タクソノミーフィルターの表示 |

#### `inc/admin.php`（管理画面カスタマイズ）

| 関数名 | 説明 |
|--------|------|
| `customize_tax_service_columns()` | 一覧画面のカラムカスタマイズ |
| `display_tax_service_column_content()` | カラム内容の表示 |
| `add_tax_service_meta_boxes()` | メタボックスの追加 |

**実装ファイル**: `inc/*.php`

---

### 6. スタイルシート

#### `style.css`

**実装内容**:
- 基本スタイル
- サービスカード（一覧ページ用）
- サービス詳細ページ
- 一覧ページ
- フィルター
- パンくずリスト
- ページネーション
- レスポンシブ対応

**設計思想**:
- BEM記法に基づいたクラス命名
- モバイルファーストのレスポンシブデザイン
- 保守性の高いCSS構造

**実装ファイル**: `style.css`

---

### 7. 自動デプロイ機能

#### GitHub Actions ワークフロー

**機能**:
- mainブランチへのプッシュ時に自動デプロイ
- SSH接続テスト
- デプロイ前の自動バックアップ
- SFTP経由でのファイル転送
- デプロイ後の検証
- 失敗時の自動ロールバック

**実装ファイル**: `.github/workflows/deploy.yml`

---

## ファイル構成

```
tax-matching-theme/
├── .github/
│   ├── workflows/
│   │   └── deploy.yml              # 自動デプロイワークフロー
│   ├── scripts/
│   │   └── rollback.sh             # ロールバックスクリプト
│   └── DEPLOYMENT.md               # デプロイ設定ガイド
├── acf-json/
│   ├── group_basic_info.json       # 基本情報フィールド
│   ├── group_listing_control.json  # 掲載制御フィールド
│   ├── group_editor_review.json    # 編集部評価フィールド
│   ├── group_service_detail.json   # サービス詳細フィールド
│   └── group_tracking.json         # トラッキングフィールド
├── inc/
│   ├── helpers.php                 # 汎用ヘルパー関数
│   ├── query.php                   # クエリ関連関数
│   ├── display.php                 # 表示関連関数
│   └── admin.php                   # 管理画面カスタマイズ
├── docs/
│   ├── data-design.md              # データ設計書
│   ├── acf-import-guide.md         # ACFインポート手順書
│   └── implementation-report.md    # 実装完了レポート（本ファイル）
├── functions.php                   # メイン関数ファイル
├── style.css                       # メインスタイルシート
├── header.php                      # ヘッダーテンプレート
├── footer.php                      # フッターテンプレート
├── index.php                       # インデックステンプレート
├── single-tax_service.php          # サービス詳細ページ
├── archive-tax_service.php         # サービス一覧ページ
├── taxonomy-service_industry.php   # 業種別一覧ページ
├── taxonomy-service_issue.php      # 課題別一覧ページ
└── README.md                       # プロジェクト説明
```

---

## 設計思想の実現

### 1. 管理しやすさ

✅ **データとロジックの分離**
- ACFフィールドで情報を管理
- タクソノミーで分類を管理
- PHPテンプレートに文言を直書きしない

✅ **役割ごとにファイルを分割**
- `inc/helpers.php` - 汎用ヘルパー関数
- `inc/query.php` - クエリ関連関数
- `inc/display.php` - 表示関連関数
- `inc/admin.php` - 管理画面カスタマイズ

✅ **設計意図のコメントを記載**
- すべてのファイルに設計意図を明記
- 関数の役割と使用方法を説明

### 2. 更新しやすさ

✅ **ACF JSON同期**
- フィールドグループをJSONで管理
- バージョン管理が可能
- 環境間での同期が容易

✅ **ヘルパー関数の活用**
- テンプレートファイルをシンプルに保つ
- 共通処理を関数化
- 変更時の影響範囲を最小化

✅ **自動デプロイ機能**
- mainブランチへのプッシュで自動デプロイ
- バックアップとロールバック機能
- デプロイ履歴の管理

### 3. 壊れにくさ

✅ **存在チェックの徹底**
- ACFフィールドの存在チェック
- タクソノミータームの存在チェック
- 画像の存在チェック

✅ **エスケープ処理の徹底**
- `esc_html()` - HTMLエスケープ
- `esc_url()` - URLエスケープ
- `esc_attr()` - 属性エスケープ
- `wp_kses_post()` - HTMLタグのサニタイズ

✅ **拡張性の確保**
- 課金モデル変更に対応
- 表示ルール変更に対応
- マッチング条件追加に対応

---

## 次のステップ

### 1. ACFフィールドのインポート

`docs/acf-import-guide.md` を参照して、ACFフィールドグループをインポートしてください。

### 2. タクソノミータームの登録

以下のタクソノミーにタームを追加してください：

- **業種**（`service_industry`）
  - 例: 飲食業、小売業、製造業、IT業、建設業など

- **課題・目的**（`service_issue`）
  - 例: 節税対策、資金繰り改善、法人設立、確定申告、相続税対策など

- **フェーズ**（`service_phase`）
  - 例: 起業準備中、創業1年目、成長期、事業承継など

- **対応エリア**（`service_area`）
  - 例: 東京都、神奈川県、大阪府、全国対応など

### 3. テストデータの作成

税理士サービスを1-2件作成して、以下を確認してください：

- ✅ すべてのACFフィールドが正しく表示される
- ✅ タクソノミーが正しく動作する
- ✅ 一覧ページで正しく表示される
- ✅ 詳細ページで正しく表示される
- ✅ 検索・フィルター機能が動作する

### 4. デザインのカスタマイズ

`style.css` を編集して、デザインをカスタマイズしてください：

- 色の変更
- フォントの変更
- レイアウトの調整
- レスポンシブデザインの最適化

### 5. 追加機能の実装

以下の機能を追加することを検討してください：

- お問い合わせフォーム
- 比較機能
- お気に入り機能
- レビュー・評価機能
- AIマッチング機能

---

## トラブルシューティング

### ACFフィールドが表示されない

**原因**: ACFプラグインが有効化されていない、またはフィールドグループが同期されていない

**解決方法**:
1. ACFプラグインをインストール・有効化
2. **「カスタムフィールド」** → **「同期可能」** タブを確認
3. すべてのフィールドグループを同期

### テンプレートが正しく表示されない

**原因**: ヘルパー関数が読み込まれていない

**解決方法**:
1. `functions.php` の `$includes` 配列を確認
2. `inc/*.php` ファイルが存在するか確認
3. PHPエラーログを確認

### デプロイが失敗する

**原因**: SSH接続情報が正しくない、またはディレクトリが存在しない

**解決方法**:
1. GitHubシークレットの設定を確認
2. SSH接続情報を確認
3. デプロイ先ディレクトリが存在するか確認
4. `.github/workflows/deploy.yml` のログを確認

---

## サポート

詳細なドキュメントは以下を参照してください：

- **データ設計書**: `docs/data-design.md`
- **ACFインポート手順書**: `docs/acf-import-guide.md`
- **デプロイ設定ガイド**: `.github/DEPLOYMENT.md`

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|----------|------|---------|
| 1.0.0 | 2026-01-19 | 初回リリース |

---

## ライセンス

GNU General Public License v2 or later

---

**実装完了日**: 2026-01-19  
**実装者**: Manus AI  
**ステータス**: ✅ 実装完了・デプロイ準備完了
