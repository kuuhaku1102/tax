# 税理士事務所データ構造の修正

## 概要

スクレイピングしたJSONデータ構造に合わせて、税理士事務所のカスタム投稿タイプを修正しました。

## 変更内容

### 1. データ構造の変更

**変更前:**
- **都道府県**: タクソノミー（ターム管理）
- **依頼内容**: タクソノミー（ターム管理）
- **業種**: タクソノミー（ターム管理）

**変更後:**
- **都道府県**: タクソノミー（ターム管理）← そのまま
- **得意分野**: カスタムフィールド（JSON配列）← 変更
- **得意業種**: カスタムフィールド（JSON配列）← 変更

### 2. 修正したファイル

#### `/inc/tax-office-post-type.php`
- カスタムフィールドに「得意分野」と「得意業種」を追加
- JSON配列として保存・取得する機能を実装
- 管理画面のメタボックスにテキストエリアを追加（1行に1つずつ入力）
- 管理画面の一覧カラムをカスタムフィールドから取得するように修正

#### `/inc/tax-office-importer.php`
- インポート機能をJSONデータ構造に対応
- `details.得意分野`をカスタムフィールド`_tax_office_services`に保存
- `details.得意業種`をカスタムフィールド`_tax_office_industries`に保存
- 弥生製品関連の情報を除外する処理を維持

#### `/single-tax_office.php`（新規作成）
- 税理士事務所詳細ページのテンプレート
- カスタムフィールドから得意分野と得意業種を取得して表示
- JSON配列をデコードしてリスト表示

#### `/archive-tax_office.php`（新規作成）
- 税理士事務所一覧ページのテンプレート
- 都道府県フィルター機能
- カード形式で事務所を表示（得意分野を最大3件表示）

## データフォーマット

### カスタムフィールド

**`_tax_office_services`（得意分野）**
```json
["法人の決算・申告","個人事業主の確定申告","記帳代行","年末調整","経理代行"]
```

**`_tax_office_industries`（得意業種）**
```json
["建設","製造","小売","卸売","飲食・宿泊"]
```

### インポートデータ構造

```json
{
  "prefecture_code": "01",
  "prefecture_name": "北海道",
  "total_offices": 10,
  "all_scraped_data": [
    {
      "name": "事務所名",
      "details": {
        "得意分野": ["法人の決算・申告", "個人事業主の確定申告", ...],
        "得意業種": ["建設", "製造", ...]
      },
      "source_url": "https://zeirishi.yayoi-kk.co.jp/offices/..."
    }
  ]
}
```

## 管理画面での操作

### 手動入力
1. 「税理士事務所」→「新規追加」または既存の事務所を編集
2. 「事務所情報」メタボックスの「得意分野」「得意業種」に1行に1つずつ入力
3. 保存すると自動的にJSON配列として保存される

### インポート
1. 「税理士事務所」→「データインポート」
2. JSONファイルをアップロード
3. 「インポート開始」をクリック
4. 自動的にカスタムフィールドに保存される

## フロントエンド表示

### 詳細ページ（single-tax_office.php）
- 事務所名
- 所在都道府県（タクソノミー）
- 得意分野（カスタムフィールドから全件表示）
- 得意業種（カスタムフィールドから全件表示）
- 事務所情報（住所、電話番号、メールアドレス、ウェブサイト）
- お問い合わせボタン

### 一覧ページ（archive-tax_office.php）
- 都道府県フィルター
- 並び順（名前順、新着順）
- カード形式で表示
- 得意分野を最大3件表示（残りは「他○件」と表示）

## メリット

1. **各事務所固有のデータを正確に保存**: タクソノミーではなくカスタムフィールドに保存することで、各事務所が持つ固有の得意分野・得意業種を正確に保持できる
2. **スクレイピングデータをそのまま保存**: JSONデータをそのまま保存できるため、データの整合性が保たれる
3. **管理が容易**: タクソノミーのターム管理が不要になり、データのインポート・管理が簡単になる
4. **柔軟性**: 事務所ごとに異なる数の得意分野・得意業種を保存できる

## 注意事項

- 既存のタクソノミー「対応可能サービス（office_service）」「対応業種（office_industry）」は残っていますが、今後は使用しません
- 既存のデータがある場合は、手動でカスタムフィールドに移行する必要があります
- 弥生製品関連の情報は自動的に除外されます

## 次のステップ

1. スクレイピングしたJSONファイルをインポート
2. フロントエンドでの表示を確認
3. 必要に応じてスタイルを調整
4. 検索・絞り込み機能を追加（オプション）

---

**更新日**: 2026年1月20日  
**コミットハッシュ**: 29a6877
