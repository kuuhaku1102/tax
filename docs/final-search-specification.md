# 最終的な検索機能の仕様

## 概要

`/services/`ページを税理士事務所専用の検索ページに変更しました。

## ページ構成

### ヘッダー
- **タイトル**: 税理士・会計事務所を探す
- **説明**: 得意業種・得意分野・都道府県から、あなたに最適な税理士事務所を見つけましょう

### 検索フォーム

| フィルター | 説明 | パラメータ名 |
|-----------|------|------------|
| 得意業種 | 税理士事務所の得意業種から選択 | `office_industry` |
| 得意分野 | 税理士事務所の得意分野から選択 | `office_service` |
| 都道府県 | 税理士事務所の所在都道府県 | `office_prefecture` |
| 並び順 | おすすめ順、新着順、名前順 | `orderby` |

### 事務所一覧
- **表示件数**: 24件/ページ
- **ページネーション**: 24件以上ある場合に表示
- **並び順**: デフォルトは名前順（昇順）

## 検索ロジック

### 1. 都道府県フィルター

```php
if (isset($_GET['office_prefecture']) && !empty($_GET['office_prefecture'])) {
    $office_query_args['tax_query'] = array(
        array(
            'taxonomy' => 'office_prefecture',
            'field' => 'slug',
            'terms' => $_GET['office_prefecture'],
        ),
    );
}
```

### 2. 得意業種・得意分野フィルター

```php
$meta_query = array('relation' => 'AND');

// 得意業種で絞り込み
if (isset($_GET['office_industry']) && !empty($_GET['office_industry'])) {
    $meta_query[] = array(
        'key' => '_tax_office_industries',
        'value' => '"' . $_GET['office_industry'] . '"',
        'compare' => 'LIKE',
    );
}

// 得意分野で絞り込み
if (isset($_GET['office_service']) && !empty($_GET['office_service'])) {
    $meta_query[] = array(
        'key' => '_tax_office_services',
        'value' => '"' . $_GET['office_service'] . '"',
        'compare' => 'LIKE',
    );
}

if (count($meta_query) > 1) {
    $office_query_args['meta_query'] = $meta_query;
}
```

**重要**: JSON配列内の値を正確に検索するため、値をダブルクォートで囲んでいます。

例: `["法人決算", "確定申告"]` から `"法人決算"` を検索

### 3. ページネーション

```php
$paged = (get_query_var('paged')) ? get_query_var('paged') : 1;
$office_query_args = array(
    'post_type' => 'tax_office',
    'posts_per_page' => 24,
    'paged' => $paged,
    'orderby' => isset($_GET['orderby']) ? $_GET['orderby'] : 'title',
    'order' => 'ASC',
);
```

## 削除した機能

### 税理士サービスセクション
- 業種フィルター（`service_industry`）
- 課題・目的フィルター（`service_issue`）
- 対応エリアフィルター（`service_area`）
- 税理士サービスの一覧表示

**理由**: 税理士事務所の検索に特化するため

## 使い方

### 基本的な検索

1. `/services/`ページにアクセス
2. フィルターで条件を選択
3. 「検索する」ボタンをクリック

### 得意業種での検索

**例: 建設業が得意な事務所を探す**

1. 「得意業種」で「建設業」を選択
2. 「検索する」ボタンをクリック
3. 得意業種に「建設業」を含む事務所のみ表示

### 得意分野での検索

**例: 法人決算が得意な事務所を探す**

1. 「得意分野」で「法人決算」を選択
2. 「検索する」ボタンをクリック
3. 得意分野に「法人決算」を含む事務所のみ表示

### 都道府県での検索

**例: 東京都の事務所を探す**

1. 「都道府県」で「東京都」を選択
2. 「検索する」ボタンをクリック
3. 東京都の事務所のみ表示

### 複数条件での検索

**例: 東京都で建設業が得意で法人決算ができる事務所を探す**

1. 「得意業種」で「建設業」を選択
2. 「得意分野」で「法人決算」を選択
3. 「都道府県」で「東京都」を選択
4. 「検索する」ボタンをクリック
5. すべての条件に一致する事務所のみ表示

## URLパラメータ

### 検索パラメータ

```
/services/?office_industry=建設業&office_service=法人決算&office_prefecture=tokyo&orderby=title
```

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `office_industry` | 得意業種（文字列） | `建設業` |
| `office_service` | 得意分野（文字列） | `法人決算` |
| `office_prefecture` | 都道府県（スラッグ） | `tokyo` |
| `orderby` | 並び順 | `priority`, `date`, `title` |
| `paged` | ページ番号 | `1`, `2`, `3`... |

### ページネーション

```
/services/?paged=2
```

## カード表示内容

各事務所カードには以下の情報が表示されます：

1. **サムネイル**: アイキャッチ画像または🏛️アイコン
2. **事務所名**: 事務所の正式名称
3. **都道府県**: 📍アイコンと都道府県名
4. **得意分野**: 最大3件のタグ表示（それ以上は「他○件」と表示）
5. **詳細リンク**: 「詳細を見る →」

## 検索結果表示

### 検索結果がある場合

```
413件の事務所が見つかりました

[事務所カード] [事務所カード] [事務所カード] ...

[ページネーション]
```

### 検索結果がない場合

```
条件に一致する事務所が見つかりませんでした
```

## 並び順

| 並び順 | 説明 | orderby値 |
|--------|------|----------|
| おすすめ順 | 優先度順（未実装） | `priority` |
| 新着順 | 投稿日時の降順 | `date` |
| 名前順 | 事務所名の昇順（デフォルト） | `title` |

## パフォーマンス最適化

### 現在の実装

- ヘルパー関数でデータベースクエリを実行
- 選択肢は毎回動的に生成

### 今後の改善案

1. **Transient APIでキャッシュ**
   - 得意業種・得意分野の選択肢をキャッシュ
   - 12時間ごとに更新

2. **Ajax検索**
   - ページリロードなしで検索結果を更新
   - ユーザー体験の向上

3. **インデックス追加**
   - `_tax_office_services`と`_tax_office_industries`にインデックス
   - 検索速度の向上

## トラブルシューティング

### 検索結果が表示されない

**原因**: データがインポートされていない

**解決策**: 
1. WordPress管理画面 → 「税理士事務所」→「データインポート」
2. JSONファイルをアップロード

### 選択肢が表示されない

**原因**: データがインポートされていない、またはヘルパー関数が読み込まれていない

**解決策**:
1. データをインポート
2. `functions.php`で`inc/helpers.php`が読み込まれているか確認

### 検索が機能しない

**原因**: JSON値の検索方法が正しくない

**解決策**:
- 値をダブルクォートで囲む: `'"' . $value . '"'`
- `LIKE`比較を使用

## まとめ

- **シンプル**: 税理士事務所のみに特化
- **直感的**: 3つのフィルターで簡単検索
- **正確**: JSON配列内の値を正確に検索
- **スケーラブル**: ページネーションで大量データに対応

---

**更新日**: 2026年1月20日  
**コミットハッシュ**: abe0301
